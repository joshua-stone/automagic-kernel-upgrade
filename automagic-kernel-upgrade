#!/bin/sh

set -e

if [ "$(uname -i)" = "x86_64" ]; then
  ARCH="amd64"
else
  ARCH="i386"
fi

CURRENT_KERNEL="$(uname -r)"

if [ "${CURRENT_KERNEL##*-}" = "generic" ]; then
  TYPE="generic"
else
  TYPE="lowlatency"
fi

echo -n "Finding latest kernel .."

URL="http://kernel.ubuntu.com/~kernel-ppa/mainline/"
HTML="$(wget -q -O - ${URL} | grep href | tail -n 1)"

VERSION="${HTML#*</td><td><a href=\"}"
VERSION="${VERSION%/\">*}"

echo ".. latest version is ${VERSION} for ${ARCH}. Continue? [y/n]"

read INPUT

if [ "${INPUT}" != "y" ]; then
  echo "Aborting."
  exit 1
fi

TEMP_DIR="$(mktemp -d)" || exit 1
trap 'rm -rf "${TEMP_DIR}"' EXIT

DIRECTORY="${URL}${VERSION}/"

wget -q -O - "${DIRECTORY}" |
grep -e "all.deb\|${TYPE}.*${ARCH}" |
cut -d \" -f8 |
while read LINK; do
  wget "${DIRECTORY}${LINK}" -P "${TEMP_DIR}"
done

echo "WARNING: Installing this kernel can break your system. Continue? [y/n]"

if [ "${INPUT}" != "y" ]; then
  echo "Aborting."
  exit 1
fi

dpkg -i "${TEMP_DIR}"/*.deb


